<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n t√≠ch Website - N·ªÅn t·∫£ng Ki·ªÉm th·ª≠ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-editor { font-family: 'Fira Code', monospace; }
        
        .active-tab { 
            border-bottom: 3px solid #52b788; 
            color: #52b788; 
            background: linear-gradient(135deg, #f0fdf4 0%, transparent 100%);
            font-weight: 600;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f0fdf4; border-radius: 10px; }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out; }
        
        .btn-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(82, 183, 136, 0.25);
        }
        
        .grad-green { background: linear-gradient(135deg, #52b788 0%, #40916c 100%); }
        .grad-blue { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
    </style>
</head>
<body class="bg-[#f1f5f9] min-h-screen">

    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-[#1b4332] to-[#2d6a4f] text-white px-6 py-3 flex justify-between items-center sticky top-0 z-50 shadow-lg">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
                <div class="bg-[#52b788] p-1.5 rounded-lg"><i class="fas fa-leaf text-white"></i></div>
                <span class="text-lg font-bold tracking-tight">AI<span class="text-[#52b788]">-TestLab</span></span>
            </div>
            <div class="hidden md:flex gap-6 text-sm font-medium text-gray-300">
                <a href="dashboard.html" class="hover:text-white transition">T·ªïng quan</a>
                <a href="#" class="text-white border-b-2 border-[#52b788] pb-1">Ph√¢n t√≠ch</a>
                <a href="test-creation.html" class="hover:text-white transition">Test Cases</a>
                <a href="#" class="hover:text-white transition">B√°o c√°o</a>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-300"><i class="far fa-clock mr-1"></i> T·ª± ƒë·ªông l∆∞u</span>
            <div class="h-8 w-8 bg-gradient-to-tr from-[#52b788] to-[#40916c] rounded-full flex items-center justify-center font-bold text-xs">WA</div>
        </div>
    </nav>

    <!-- Main Grid Layout -->
    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-0 shadow-2xl mt-4 rounded-xl overflow-hidden bg-white border border-gray-200">
        
        <!-- Sidebar -->
        <aside class="col-span-2 border-r border-gray-200 bg-gradient-to-b from-[#f8fafb] via-[#f0fdf4] to-[#ffffff] p-4 h-[calc(100vh-100px)] custom-scrollbar overflow-y-auto shadow-inner">
            <div class="flex justify-between items-center mb-6 pb-3 border-b-2 border-gray-200">
                <h2 class="text-xs font-black text-[#1b4332] uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-history text-[#52b788]"></i>L·ªãch S·ª≠
                </h2>
                <button onclick="clearHistory()" class="text-[#52b788] hover:bg-[#d1f5d1] p-2 rounded-lg transition-all hover:scale-110 shadow-sm btn-modern">
                    <i class="fas fa-trash-alt text-lg"></i>
                </button>
            </div>

            <!-- Websites List -->
            <div id="websitesList" class="space-y-2 mb-6">
                <div class="text-xs text-gray-400 p-3 italic text-center animate-pulse">
                    <i class="fas fa-history mr-2"></i>Ch∆∞a c√≥ website
                </div>
            </div>

            <div class="border-t-2 border-gray-200 pt-4">
                <h3 class="text-xs font-black text-[#1b4332] uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-[#52b788]"></i>Th·ªëng K√™
                </h3>
                <div class="space-y-3">
                    <div class="bg-gradient-to-br from-[#f0fdf4] to-[#e8f5e9] p-3 rounded-lg border-l-4 border-[#52b788]">
                        <div class="text-[10px] text-gray-600 font-semibold">WEBSITE ƒê√É PH√ÇN T√çCH</div>
                        <div class="text-2xl font-black text-[#52b788]" id="statWebsites">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-[#d1f5d1] to-[#c8f0d8] p-3 rounded-lg border-l-4 border-[#40916c]">
                        <div class="text-[10px] text-gray-600 font-semibold">T·ªîNG PH·∫¶N T·ª¨</div>
                        <div class="text-2xl font-black text-[#40916c]" id="statElements">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-100 to-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="text-[10px] text-gray-600 font-semibold">TEST ƒê∆Ø·ª¢C SINH RA</div>
                        <div class="text-2xl font-black text-blue-600" id="statTests">0</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="col-span-7 border-x border-gray-200 h-[calc(100vh-100px)] flex flex-col">
            
            <!-- Header -->
            <div class="p-6 border-b-2 border-gray-200 flex justify-between items-center bg-gradient-to-r from-white to-[#f0fdf4] shadow-sm">
                <div class="flex items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-black text-[#1b4332]">Ph√¢n T√≠ch Website</h2>
                        <p class="text-xs text-gray-500 mt-1"><i class="fas fa-lightbulb mr-1"></i>Ph√¢n t√≠ch website v√† t·ª± ƒë·ªông sinh test case</p>
                    </div>
                </div>
                <button id="analyzeBtn" onclick="analyzeWebsite()" class="flex items-center gap-2 bg-gradient-to-r from-[#52b788] to-[#40916c] text-white px-6 py-3 rounded-lg text-sm font-black hover:shadow-lg btn-modern shadow-lg shadow-green-200/50 transition-all">
                    <i class="fas fa-play"></i> Ph√¢n T√≠ch Ngay
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="flex bg-gradient-to-r from-[#f8fafb] to-white border-b-2 border-gray-200 shadow-sm">
                <button onclick="switchTab('url')" id="btn-url" class="px-8 py-3 text-sm font-black active-tab transition-all flex items-center gap-2 text-[#1b4332] border-b-4 border-[#52b788]">
                    <i class="fas fa-link text-lg"></i> Theo URL
                </button>
                <button onclick="switchTab('upload')" id="btn-upload" class="px-8 py-3 text-sm font-black text-gray-500 hover:text-[#52b788] transition-all flex items-center gap-2 hover:bg-white/50 group relative">
                    <i class="fas fa-upload text-lg"></i> T·∫£i File HTML
                    <span class="absolute bottom-1 left-8 w-0 h-0.5 bg-[#52b788] group-hover:w-12 transition-all"></span>
                </button>
                <button onclick="switchTab('results')" id="btn-results" class="px-8 py-3 text-sm font-black text-gray-500 hover:text-[#52b788] transition-all flex items-center gap-2 hover:bg-white/50 group relative">
                    <i class="fas fa-chart-pie text-lg"></i> K·∫øt Qu·∫£
                    <span class="absolute bottom-1 left-8 w-0 h-0.5 bg-[#52b788] group-hover:w-12 transition-all"></span>
                </button>
            </div>

            <!-- URL Tab -->
            <div id="panel-url" class="flex-grow overflow-y-auto p-6 block bg-gradient-to-br from-white via-[#f8fafb] to-[#f0fdf4]">
                <div class="max-w-2xl">
                    <div class="mb-6">
                        <label class="text-sm font-black text-[#1b4332] uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fas fa-globe text-[#52b788]"></i>URL Website
                        </label>
                        <div class="flex gap-3">
                            <input type="url" id="websiteUrl" placeholder="https://example.com" 
                                class="flex-1 border-2 border-[#d1f5d1] p-4 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white font-medium transition-all" />
                            <button onclick="analyzeWebsite()" class="bg-gradient-to-r from-[#52b788] to-[#40916c] text-white px-6 rounded-lg text-sm font-black hover:shadow-lg btn-modern transition-all">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="bg-gradient-to-br from-[#f0fdf4] to-[#e8f5e9] p-5 rounded-lg border-2 border-[#d1f5d1] space-y-4">
                        <label class="text-xs font-black text-[#1b4332] uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-sliders-h text-[#52b788]"></i>T√πy Ch·ªçn Ph√¢n T√≠ch
                        </label>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-white/50 p-2 rounded transition">
                                <input type="checkbox" id="analyzeLinks" checked class="w-4 h-4 accent-[#52b788]">
                                <span class="text-sm font-medium text-[#1b4332]">Ph√¢n t√≠ch Li√™n k·∫øt</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-white/50 p-2 rounded transition">
                                <input type="checkbox" id="analyzeForms" checked class="w-4 h-4 accent-[#52b788]">
                                <span class="text-sm font-medium text-[#1b4332]">Ph√¢n t√≠ch Form</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-white/50 p-2 rounded transition">
                                <input type="checkbox" id="analyzeButtons" checked class="w-4 h-4 accent-[#52b788]">
                                <span class="text-sm font-medium text-[#1b4332]">Ph√¢n t√≠ch N√∫t</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-white/50 p-2 rounded transition">
                                <input type="checkbox" id="analyzeInputs" checked class="w-4 h-4 accent-[#52b788]">
                                <span class="text-sm font-medium text-[#1b4332]">Ph√¢n t√≠ch Input</span>
                            </label>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" style="display: none;" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-[#52b788] mb-3"></i>
                        <p class="text-sm text-gray-600 font-semibold">ƒêang ph√¢n t√≠ch website...</p>
                    </div>
                </div>
            </div>

            <!-- Upload Tab -->
            <div id="panel-upload" style="display: none;" class="flex-grow overflow-y-auto p-6 bg-gradient-to-br from-white via-[#f8fafb] to-[#f0fdf4]">
                <div class="max-w-2xl">
                    <div class="border-2 border-dashed border-[#52b788] rounded-lg p-8 text-center cursor-pointer hover:bg-[#f0fdf4] transition" onclick="document.getElementById('htmlFileInput').click()">
                        <i class="fas fa-cloud-upload-alt text-[#52b788] text-5xl mb-3 block"></i>
                        <p class="text-[#1b4332] font-bold mb-1 text-lg">K√©o & Th·∫£ File HTML ho·∫∑c Nh·∫•p ƒë·ªÉ Ch·ªçn</p>
                        <p class="text-gray-500 text-sm">H·ªó tr·ª£: .html, .htm</p>
                        <input type="file" id="htmlFileInput" class="hidden" accept=".html,.htm" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="panel-results" style="display: none;" class="flex-grow overflow-y-auto bg-gradient-to-br from-white via-[#f8fafb] to-[#f0fdf4]">
                <div class="p-6 space-y-8">
                    <!-- Detected Features Section -->
                    <div class="bg-white rounded-xl border-2 border-[#d1f5d1] shadow-md overflow-hidden">
                        <div class="bg-gradient-to-r from-[#52b788] to-[#40916c] px-6 py-4">
                            <h4 class="text-lg font-black text-white flex items-center gap-3">
                                <i class="fas fa-star text-yellow-300"></i> Ch·ª©c NƒÉng & T√≠nh NƒÉng ƒê∆∞·ª£c Ph√°t Hi·ªán
                            </h4>
                            <p class="text-sm text-green-100 mt-1">C√°c t√≠nh nƒÉng ƒë∆∞·ª£c ph√°t hi·ªán trong qu√° tr√¨nh ph√¢n t√≠ch</p>
                        </div>
                        <div class="p-6" id="detectedFeatures">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                                <p class="text-sm">Ch∆∞a ph√°t hi·ªán t√≠nh nƒÉng. H√£y ch·∫°y ph√¢n t√≠ch tr∆∞·ªõc.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Test Cases Section -->
                    <div class="bg-white rounded-xl border-2 border-blue-300 shadow-md overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                            <h4 class="text-lg font-black text-white flex items-center gap-3">
                                <i class="fas fa-flask text-blue-200"></i> Test Case ƒê∆∞·ª£c AI Sinh Ra
                            </h4>
                            <p class="text-sm text-blue-100 mt-1">C√°c k·ªãch b·∫£n ki·ªÉm th·ª≠ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi AI</p>
                        </div>
                        <div class="p-6" id="generatedTestCases">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                                <p class="text-sm">Ch∆∞a c√≥ test case. H√£y ch·∫°y ph√¢n t√≠ch tr∆∞·ªõc.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="col-span-3 bg-gradient-to-b from-white via-[#f8fafb] to-[#f0fdf4] p-6 h-[calc(100vh-100px)] overflow-y-auto custom-scrollbar shadow-inner">
            <h3 class="text-sm font-black mb-6 flex items-center gap-3 border-b-2 border-gray-200 pb-4 text-[#1b4332] uppercase tracking-wider">
                <i class="fas fa-cog text-[#52b788] text-lg"></i> C·∫•u H√¨nh
            </h3>

            <div class="space-y-6">
                <!-- Website Info -->
                <div class="bg-gradient-to-br from-[#f0fdf4] via-[#f8fafb] to-white p-5 rounded-xl border-2 border-[#d1f5d1] space-y-4 shadow-sm">
                    <label class="text-[11px] font-black text-[#1b4332] uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-info-circle text-[#52b788]"></i>Th√¥ng Tin Website
                    </label>
                    
                    <div>
                        <label class="text-[10px] font-black text-[#52b788] uppercase tracking-wide">T√™n Website</label>
                        <input type="text" id="siteName" class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm mt-2 focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white font-medium transition-all" placeholder="Website c·ªßa t√¥i">
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-[#52b788] uppercase tracking-wide">M√¥ T·∫£</label>
                        <textarea id="siteDescription" class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm mt-2 focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white font-medium transition-all resize-none" placeholder="Website n√†y l√†m g√¨?" rows="3"></textarea>
                    </div>
                </div>

                <!-- Test Settings -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl border-2 border-blue-200 space-y-4 shadow-sm">
                    <label class="text-[11px] font-black text-blue-900 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-sliders-h text-blue-600"></i>C√†i ƒê·∫∑t Test
                    </label>

                    <div>
                        <label class="text-[10px] font-black text-blue-700 uppercase tracking-wide">Lo·∫°i Test</label>
                        <select id="testType" class="w-full border-2 border-blue-300 p-3 rounded-lg text-sm mt-2 focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-300/30 bg-white font-semibold transition-all">
                            <option value="functional">üîß Ki·ªÉm Th·ª≠ Ch·ª©c NƒÉng</option>
                            <option value="ui">üé® Ki·ªÉm Th·ª≠ Giao Di·ªán</option>
                            <option value="security">üîí Ki·ªÉm Th·ª≠ B·∫£o M·∫≠t</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-2 pt-4 border-t-2 border-gray-200">
                    <button onclick="generateReport()" class="w-full bg-gradient-to-r from-[#52b788] to-[#40916c] text-white px-4 py-3 rounded-lg font-black hover:shadow-lg btn-modern transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-file-pdf"></i> T·∫°o B√°o C√°o
                    </button>
                    <button onclick="saveAnalysis()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-lg font-black hover:shadow-lg btn-modern transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> L∆∞u Ph√¢n T√≠ch
                    </button>
                    <button onclick="clearAnalysis()" class="w-full bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-black hover:bg-gray-400 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-trash"></i> X√≥a
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentAnalysis = null;

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'auth.html';
        }

        function switchTab(tab) {
            document.querySelectorAll('[id^="panel-"]').forEach(p => p.style.display = 'none');
            document.querySelectorAll('[id^="btn-"]').forEach(b => b.classList.remove('active-tab'));
            
            document.getElementById(`panel-${tab}`).style.display = 'block';
            document.getElementById(`btn-${tab}`).classList.add('active-tab');
        }

        async function analyzeWebsite() {
            const url = document.getElementById('websiteUrl').value;
            if (!url) {
                alert('Vui l√≤ng nh·∫≠p URL website');
                return;
            }

            document.getElementById('loadingState').style.display = 'block';
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
                    window.location.href = 'auth.html';
                    return;
                }

                // Call backend API for website analysis with AI
                console.log('üöÄ G·ª≠i y√™u c·∫ßu ph√¢n t√≠ch ƒë·∫øn backend...');
                const response = await fetch(`${API_URL}/api/website-analyzer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`API L·ªói: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ API Ph·∫£n h·ªìi:', data);

                // Process backend response
                let detectedFeatures = data.features || data.detectedFeatures || [];
                let generatedTestCases = data.testCases || data.generatedTestCases || [];

                console.log('üìä Received features:', detectedFeatures.length);
                console.log('üìä Received test cases:', generatedTestCases.length);

                // Fallback to mock data if API doesn't return features
                if (detectedFeatures.length === 0) {
                    console.warn('‚ö†Ô∏è No features from backend, using mock data');
                    detectedFeatures = [
                        { 
                            name: 'X√°c Th·ª±c Ng∆∞·ªùi D√πng', 
                            type: 'ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω', 
                            complexity: 'Cao', 
                            elements: 8,
                            testCases: [
                                { id: 'AUTH001', name: 'ƒêƒÉng k√Ω v·ªõi d·ªØ li·ªáu h·ª£p l·ªá', steps: ['V√†o trang ƒëƒÉng k√Ω', 'Nh·∫≠p email h·ª£p l·ªá', 'Nh·∫≠p m·∫≠t kh·∫©u >= 8 k√Ω t·ª±', 'Nh·∫•p ƒêƒÉng k√Ω'], expectedResult: 'T√†i kho·∫£n ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng', priority: 'Critical', status: 'PASSED', executionTime: '2.3s' },
                                { id: 'AUTH002', name: 'ƒêƒÉng nh·∫≠p v·ªõi th√¥ng tin h·ª£p l·ªá', steps: ['V√†o trang ƒëƒÉng nh·∫≠p', 'Nh·∫≠p email ƒë√£ ƒëƒÉng k√Ω', 'Nh·∫≠p m·∫≠t kh·∫©u ƒë√∫ng', 'Nh·∫•p ƒêƒÉng nh·∫≠p'], expectedResult: 'ƒê∆∞·ª£c chuy·ªÉn h∆∞·ªõng ƒë·∫øn dashboard', priority: 'Critical', status: 'PASSED', executionTime: '1.8s' },
                                { id: 'AUTH003', name: 'ƒêƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u sai', steps: ['V√†o trang ƒëƒÉng nh·∫≠p', 'Nh·∫≠p email h·ª£p l·ªá', 'Nh·∫≠p m·∫≠t kh·∫©u sai', 'Nh·∫•p ƒêƒÉng nh·∫≠p'], expectedResult: 'Hi·ªÉn th·ªã th√¥ng b√°o l·ªói', priority: 'High', status: 'PASSED', executionTime: '1.5s' }
                            ]
                        },
                        { 
                            name: 'T√≠nh NƒÉng T√¨m Ki·∫øm', 
                            type: 'Thanh T√¨m Ki·∫øm', 
                            complexity: 'Trung B√¨nh', 
                            elements: 3,
                            testCases: [
                                { id: 'SEARCH001', name: 'T√¨m ki·∫øm v·ªõi t·ª´ kh√≥a h·ª£p l·ªá', steps: ['Nh·∫•p v√†o thanh t√¨m ki·∫øm', 'Nh·∫≠p t√™n s·∫£n ph·∫©m', 'Nh·∫•p Enter', 'X√°c minh k·∫øt qu·∫£'], expectedResult: 'Hi·ªÉn th·ªã s·∫£n ph·∫©m li√™n quan', priority: 'High', status: 'FAILED', executionTime: '3.5s' },
                                { id: 'SEARCH002', name: 'T√¨m ki·∫øm v·ªõi t·ª´ kh√≥a tr·ªëng', steps: ['Nh·∫•p v√†o thanh t√¨m ki·∫øm', 'Kh√¥ng nh·∫≠p g√¨', 'Nh·∫•p Enter'], expectedResult: 'Hi·ªÉn th·ªã th√¥ng b√°o l·ªói', priority: 'Medium', status: 'PASSED', executionTime: '1.2s' }
                            ]
                        },
                        { 
                            name: 'Gi·ªè H√†ng', 
                            type: 'Th∆∞∆°ng M·∫°i ƒêi·ªán T·ª≠', 
                            complexity: 'Cao', 
                            elements: 12,
                            testCases: [
                                { id: 'CART001', name: 'Th√™m s·∫£n ph·∫©m v√†o gi·ªè', steps: ['Ch·ªçn s·∫£n ph·∫©m', 'Ch·ªçn s·ªë l∆∞·ª£ng', 'Nh·∫•p Th√™m v√†o gi·ªè', 'X√°c minh s·ªë l∆∞·ª£ng'], expectedResult: 'S·∫£n ph·∫©m ƒë∆∞·ª£c th√™m th√†nh c√¥ng', priority: 'Critical', status: 'PASSED', executionTime: '1.5s' },
                                { id: 'CART002', name: 'X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè', steps: ['M·ªü gi·ªè h√†ng', 'T√¨m s·∫£n ph·∫©m', 'Nh·∫•p n√∫t X√≥a', 'X√°c minh gi·ªè'], expectedResult: 'S·∫£n ph·∫©m b·ªã lo·∫°i b·ªè', priority: 'High', status: 'PASSED', executionTime: '1.8s' },
                                { id: 'CART003', name: 'C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng', steps: ['M·ªü gi·ªè h√†ng', 'Thay ƒë·ªïi s·ªë l∆∞·ª£ng', 'Nh·∫•p C·∫≠p nh·∫≠t'], expectedResult: 'S·ªë l∆∞·ª£ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t', priority: 'Medium', status: 'PASSED', executionTime: '1.3s' }
                            ]
                        }
                    ];
                }

                if (generatedTestCases.length === 0) {
                    generatedTestCases = [];
                }

                // Ensure all features have elements count and testCases
                detectedFeatures = detectedFeatures.map(feature => {
                    // Count elements if not provided
                    if (!feature.elements) {
                        const testCases = feature.testCases || [];
                        feature.elements = testCases.reduce((count, tc) => count + (tc.steps || []).length, 0) || 0;
                    }
                    
                    // Assign test cases if not already present
                    if (!feature.testCases) {
                        feature.testCases = [];
                    }
                    
                    // Ensure all test cases have a status field
                    feature.testCases = feature.testCases.map(tc => ({
                        ...tc,
                        status: tc.status || 'PENDING',
                        executionTime: tc.executionTime || '0s'
                    }));
                    
                    console.log('üìã Feature processed:', feature.name, '- Elements:', feature.elements, '- Tests:', feature.testCases.length);
                    return feature;
                });

                currentAnalysis = {
                    url: url,
                    features: detectedFeatures,
                    testCases: generatedTestCases
                };

                // Store features for modal access
                allFeatures = detectedFeatures;

                // Display detected features
                const featuresHTML = detectedFeatures.map((f, idx) => `
                    <div class="bg-gradient-to-br from-[#f0fdf4] to-[#e8f5e9] p-5 rounded-lg border-l-4 border-[#52b788] mb-4 hover:shadow-lg hover:cursor-pointer transition-all hover:scale-[1.02] transform" onclick="openFeatureModal(${idx})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h5 class="font-black text-[#1b4332] flex items-center gap-2 mb-2">
                                    <i class="fas fa-cube text-[#52b788]"></i>${f.name || f.feature}
                                </h5>
                                <p class="text-xs text-gray-600 mb-2"><strong>Lo·∫°i:</strong> ${f.type || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                                <div class="flex gap-2">
                                    <span class="px-2 py-1 bg-[#d1f5d1] text-[#1b4332] rounded text-xs font-bold">${f.complexity || 'Trung B√¨nh'}</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">${f.elements || 0} ph·∫ßn t·ª≠</span>
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold" id="testCount${idx}">${(f.testCases || []).length} test</span>
                                </div>
                                <p class="text-xs text-[#52b788] font-semibold mt-2 hover:underline"><i class="fas fa-click mr-1"></i>Nh·∫•p ƒë·ªÉ xem chi ti·∫øt</p>
                            </div>
                            <div class="text-3xl font-black text-[#52b788]/20">${idx + 1}</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('detectedFeatures').innerHTML = featuresHTML;

                // Count total test cases across all features
                const totalTests = detectedFeatures.reduce((sum, f) => sum + (f.testCases || []).length, 0);

                // Display test cases summary grouped by feature
                const testCasesHTML = detectedFeatures.map(feature => {
                    const testCases = feature.testCases || [];
                    if (testCases.length === 0) return '';
                    
                    const casesHTML = testCases.map(tc => {
                        const statusColor = tc.status === 'PASSED' ? 'text-green-700' : tc.status === 'FAILED' ? 'text-red-700' : 'text-yellow-700';
                        const statusIcon = tc.status === 'PASSED' ? 'fa-check-circle text-green-500' : tc.status === 'FAILED' ? 'fa-times-circle text-red-500' : 'fa-clock text-yellow-500';
                        return `
                            <div class="p-3 bg-gray-50 rounded border-l-4 ${tc.status === 'PASSED' ? 'border-green-400' : tc.status === 'FAILED' ? 'border-red-400' : 'border-yellow-400'} mb-2">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-sm font-bold ${statusColor} flex items-center gap-2">
                                            <i class="fas ${statusIcon}"></i>${tc.name || tc.title}
                                        </p>
                                        <p class="text-xs text-gray-600 mt-1"><strong>ID:</strong> ${tc.id}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-bold ${tc.status === 'PASSED' ? 'bg-green-100 text-green-700' : tc.status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} rounded">${tc.status || 'PENDING'}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="mb-6 border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                            <h5 class="font-black text-blue-900 mb-3 flex items-center gap-2">
                                <i class="fas fa-folder text-blue-600"></i> ${feature.name || feature.feature}
                            </h5>
                            <div class="space-y-0">${casesHTML}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('generatedTestCases').innerHTML = testCasesHTML || '<div class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><p class="text-sm">Ch∆∞a c√≥ test case. H√£y ch·∫°y ph√¢n t√≠ch tr∆∞·ªõc.</p></div>';

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('statWebsites').textContent = 1;
                document.getElementById('statElements').textContent = detectedFeatures.length;
                document.getElementById('statTests').textContent = totalTests;
                
                // Automatically switch to results tab
                switchTab('results');
                
                alert('‚úÖ Ph√¢n t√≠ch ho√†n t·∫•t! Ph√°t hi·ªán ' + detectedFeatures.length + ' t√≠nh nƒÉng, sinh ra ' + totalTests + ' test case.');
                
            } catch (error) {
                console.error('‚ùå L·ªói Ph√¢n T√≠ch:', error);
                alert('‚ùå L·ªói: ' + error.message + '\n\nL∆∞u √Ω:\n1. Backend API ph·∫£i ch·∫°y tr√™n http://localhost:3000\n2. B·∫°n c·∫ßn c√≥ token x√°c th·ª±c h·ª£p l·ªá\n3. Google Gemini API ph·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh (cho t√≠nh nƒÉng AI)');
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function handleFileUpload(event) {
            alert('File upload feature coming soon');
        }

        function generateReport() {
            alert('Report generation coming soon');
        }

        function saveAnalysis() {
            if (!currentAnalysis) {
                alert('No analysis to save');
                return;
            }
            alert('Analysis saved!');
        }

        function clearAnalysis() {
            currentAnalysis = null;
            document.getElementById('statWebsites').textContent = '0';
            document.getElementById('statElements').textContent = '0';
            document.getElementById('statTests').textContent = '0';
        }

        function clearHistory() {
            document.getElementById('websitesList').innerHTML = '<div class="text-xs text-gray-400 p-3 italic text-center">Ch∆∞a c√≥ website</div>';
        }

        let allFeatures = [];
        let selectedFeatureIndex = -1;

        async function openFeatureModal(featureIndex) {
            selectedFeatureIndex = featureIndex;
            const feature = allFeatures[featureIndex];
            
            document.getElementById('featureTitle').textContent = feature.name || feature.feature;
            document.getElementById('featureType').textContent = `Lo·∫°i: ${feature.type || 'Kh√¥ng x√°c ƒë·ªãnh'} | ƒê·ªô ph·ª©c t·∫°p: ${feature.complexity || 'Trung B√¨nh'}`;
            
            document.getElementById('featureModal').style.display = 'flex';
            
            // Only generate test cases if we don't have them yet
            if (!feature.testCases || feature.testCases.length === 0) {
                console.log('üÜï No test cases yet, generating from AI...');
                // Show loading state in modal
                document.getElementById('featureTestCases').innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="text-sm text-gray-600 mt-2">ƒêang sinh test case t·ª´ AI...</p></div>';
                
                try {
                    // Call AI to generate detailed test cases for this feature
                    const token = localStorage.getItem('token');
                    console.log('üîÑ Calling AI to generate test cases for:', feature.name);
                    console.log('üìç API URL:', `${API_URL}/api/generate-feature-tests`);
                    
                    const response = await fetch(`${API_URL}/api/generate-feature-tests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            featureName: feature.name || feature.feature,
                            featureType: feature.type || '',
                            featureDescription: `Website feature with ${feature.elements || 0} elements and ${feature.complexity || 'medium'} complexity`
                        })
                    });

                    console.log('üì¶ API Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ AI Generated test cases:', data);
                    
                    // Update feature with AI-generated test cases
                    if (data.testCases && Array.isArray(data.testCases)) {
                        allFeatures[featureIndex].testCases = data.testCases;
                        console.log('üìù Updated feature with test cases, total:', data.testCases.length);
                    }
                    
                } catch (error) {
                    console.error('‚ùå AI generation error:', error);
                    // Use existing test cases as fallback
                    console.warn('‚ö†Ô∏è Using existing test cases from analysis');
                }
            } else {
                console.log('‚ôªÔ∏è Test cases already exist, just refreshing display');
            }
            
            const testCases = feature.testCases || [];
            const testCasesHTML = testCases.map((tc, idx) => {
                const statusBg = tc.status === 'PASSED' ? 'from-green-50 to-green-100 border-green-400' : tc.status === 'FAILED' ? 'from-red-50 to-red-100 border-red-400' : 'from-yellow-50 to-yellow-100 border-yellow-400';
                const statusColor = tc.status === 'PASSED' ? 'text-green-900' : tc.status === 'FAILED' ? 'text-red-900' : 'text-yellow-900';
                const statusIcon = tc.status === 'PASSED' ? 'fa-check-circle text-green-500' : tc.status === 'FAILED' ? 'fa-times-circle text-red-500' : 'fa-clock text-yellow-500';
                const statusBadge = tc.status === 'PASSED' ? 'bg-green-100 text-green-700' : tc.status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';
                const isAIBadge = tc.isAIGenerated ? '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-black ml-1">ü§ñ AI</span>' : '';
                
                return `
                    <div class="bg-gradient-to-br ${statusBg} p-4 rounded-lg border-l-4 mb-3 hover:shadow-md transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas ${statusIcon} text-lg"></i>
                                    <h5 class="font-black ${statusColor}">${tc.name || tc.title}</h5>
                                </div>
                                <p class="text-xs ${statusColor} opacity-75"><strong>ID:</strong> ${tc.id}${isAIBadge}</p>
                            </div>
                            <div class="text-right space-y-1">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-black block">${tc.priority || 'Medium'}</span>
                                <span class="px-2 py-1 ${statusBadge} rounded text-xs font-black block">${tc.status || 'PENDING'}</span>
                                <p class="text-xs opacity-75 font-bold">‚è±Ô∏è ${tc.executionTime || '0s'}</p>
                            </div>
                        </div>
                        <div class="mt-3 space-y-2">
                            <div>
                                <p class="text-xs font-bold ${statusColor} mb-1">C√°c B∆∞·ªõc:</p>
                                <ol class="text-xs ${statusColor} opacity-90 space-y-1 ml-4 list-decimal">
                                    ${(tc.steps || []).map(s => `<li>${s}</li>`).join('')}
                                </ol>
                            </div>
                            <div class="pt-2 border-t-2 ${tc.status === 'PASSED' ? 'border-green-300' : tc.status === 'FAILED' ? 'border-red-300' : 'border-yellow-300'}">
                                <p class="text-xs"><strong class="${statusColor}">K·∫øt Qu·∫£ D·ª± Ki·∫øn:</strong> <span class="${statusColor} opacity-90">${tc.expectedResult || tc.expected_result || 'N/A'}</span></p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="runTestCase(${selectedFeatureIndex}, ${idx})" class="flex-1 text-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded flex items-center justify-center gap-1 transition-all hover:shadow-md">
                                <i class="fas fa-play"></i> Ch·∫°y Test
                            </button>
                            <button onclick="deleteTestCase(${selectedFeatureIndex}, ${idx})" class="text-xs text-red-600 hover:text-red-700 font-bold hover:underline flex items-center gap-1 px-2">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('featureTestCases').innerHTML = testCasesHTML || '<p class="text-gray-500 text-sm italic">Ch∆∞a c√≥ test case</p>';
            
            // Update overall statistics with new test case counts
            updateTestStatistics();
        }

        function updateTestStatistics() {
            console.log('üìä ===== UPDATING TEST STATISTICS =====');
            console.log('üìä C·∫≠p nh·∫≠t th·ªëng k√™ test - allFeatures count:', allFeatures.length);
            
            // Count total test cases across all features
            const totalTests = allFeatures.reduce((sum, f) => sum + (f.testCases || []).length, 0);
            console.log('üìä Total tests:', totalTests);
            
            document.getElementById('statTests').textContent = totalTests;
            
            // Update the "Test Case ƒê∆∞·ª£c AI Sinh Ra" section
            const testCasesHTML = allFeatures.map((feature, fIdx) => {
                const testCases = feature.testCases || [];
                console.log(`\nüìã Feature ${fIdx}: ${feature.name} - ${testCases.length} test cases`);
                
                if (testCases.length === 0) {
                    console.log(`   ‚Üí Skipping (no tests)`);
                    return '';
                }
                
                const casesHTML = testCases.map((tc, tcIdx) => {
                    console.log(`   Test ${tcIdx + 1}: ${tc.name} - Status: ${tc.status}`);
                    
                    const statusColor = tc.status === 'PASSED' ? 'text-green-700' : tc.status === 'FAILED' ? 'text-red-700' : 'text-yellow-700';
                    const statusIcon = tc.status === 'PASSED' ? 'fa-check-circle text-green-500' : tc.status === 'FAILED' ? 'fa-times-circle text-red-500' : 'fa-clock text-yellow-500';
                    const isAIBadge = tc.isAIGenerated ? '<span class="ml-1 text-xs px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded font-bold">ü§ñ</span>' : '';
                    return `
                        <div class="p-3 bg-gray-50 rounded border-l-4 ${tc.status === 'PASSED' ? 'border-green-400' : tc.status === 'FAILED' ? 'border-red-400' : 'border-yellow-400'} mb-2">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-bold ${statusColor} flex items-center gap-2">
                                        <i class="fas ${statusIcon}"></i>${tc.name || tc.title}${isAIBadge}
                                    </p>
                                    <p class="text-xs text-gray-600 mt-1"><strong>ID:</strong> ${tc.id}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold ${tc.status === 'PASSED' ? 'bg-green-100 text-green-700' : tc.status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} rounded">${tc.status || 'PENDING'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="mb-6 border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                        <h5 class="font-black text-blue-900 mb-3 flex items-center gap-2">
                            <i class="fas fa-folder text-blue-600"></i> ${feature.name || feature.feature}
                        </h5>
                        <div class="space-y-0">${casesHTML}</div>
                    </div>
                `;
            }).join('');
            
            const generatedTestCasesDiv = document.getElementById('generatedTestCases');
            console.log('üéØ generatedTestCasesDiv element:', generatedTestCasesDiv ? 'FOUND' : 'NOT FOUND!!');
            
            if (generatedTestCasesDiv) {
                console.log('üìù Setting innerHTML with', testCasesHTML.length, 'characters');
                generatedTestCasesDiv.innerHTML = testCasesHTML || '<div class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><p class="text-sm">Ch∆∞a c√≥ test case. H√£y ch·∫°y ph√¢n t√≠ch tr∆∞·ªõc.</p></div>';
                console.log('‚úÖ HTML updated successfully');
                console.log('üìä ===== UPDATE COMPLETE =====\n');
            } else {
                console.error('‚ùå Could not find generatedTestCases div!');
            }
        }

        function closeFeatureModal() {
            document.getElementById('featureModal').style.display = 'none';
            selectedFeatureIndex = -1;
        }

        function addCustomTestCase() {
            if (selectedFeatureIndex === -1) return;
            
            const name = document.getElementById('customTestName').value.trim();
            const stepsText = document.getElementById('customTestSteps').value.trim();
            const expected = document.getElementById('customTestExpected').value.trim();
            const priority = document.getElementById('customTestPriority').value;
            const status = document.getElementById('customTestStatus').value;
            
            if (!name || !stepsText || !expected) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            const steps = stepsText.split('\n').filter(s => s.trim()).map(s => s.trim());
            const customTest = {
                id: `CUSTOM${Date.now()}`,
                name: name,
                steps: steps,
                expectedResult: expected,
                priority: priority,
                status: status,
                executionTime: '0s',
                isCustom: true
            };
            
            if (!allFeatures[selectedFeatureIndex].testCases) {
                allFeatures[selectedFeatureIndex].testCases = [];
            }
            allFeatures[selectedFeatureIndex].testCases.push(customTest);
            
            // Clear form
            document.getElementById('customTestName').value = '';
            document.getElementById('customTestSteps').value = '';
            document.getElementById('customTestExpected').value = '';
            document.getElementById('customTestPriority').value = 'Medium';
            document.getElementById('customTestStatus').value = 'PENDING';
            
            // Update total test count
            document.getElementById('statTests').textContent = parseInt(document.getElementById('statTests').textContent) + 1;
            
            // Refresh modal
            openFeatureModal(selectedFeatureIndex);
            updateTestStatistics();
            alert('‚úÖ Th√™m test case th√†nh c√¥ng!');
        }

        function deleteTestCase(featureIndex, testIndex) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a test case n√†y?')) {
                allFeatures[featureIndex].testCases.splice(testIndex, 1);
                document.getElementById('statTests').textContent = parseInt(document.getElementById('statTests').textContent) - 1;
                openFeatureModal(featureIndex);
            }
        }

        async function runTestCase(featureIndex, testIndex) {
            const feature = allFeatures[featureIndex];
            const testCase = feature.testCases[testIndex];
            
            console.log('üöÄ Ch·∫°y test case:', testCase.name);
            console.log('üìç Feature Index:', featureIndex, 'Test Index:', testIndex);
            console.log('üìä allFeatures length:', allFeatures.length);
            console.log('üìä Current feature:', feature);
            console.log('üìä Current test case before run:', testCase);
            console.log('üìä Status before:', testCase.status);
            
            // Show loading state on button
            const buttons = document.querySelectorAll('button');
            const runBtn = Array.from(buttons).find(btn => btn.textContent.includes('Ch·∫°y Test'));
            if (runBtn) {
                runBtn.disabled = true;
                runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ch·∫°y...';
            }
            
            try {
                const token = localStorage.getItem('token');
                
                // Call backend to execute test case
                const response = await fetch(`${API_URL}/api/execute-test-case`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        testCaseId: testCase.id,
                        featureName: feature.name,
                        steps: testCase.steps,
                        expectedResult: testCase.expectedResult
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ API Response:', result);
                    console.log('‚úÖ Response status field:', result.status);
                    
                    // Update test case status based on execution result
                    const newStatus = result.status || 'PASSED';
                    const newTime = result.executionTime || '0s';
                    
                    console.log('üìù Setting status to:', newStatus);
                    console.log('üìù Setting time to:', newTime);
                    
                    // Update the actual test case object in allFeatures
                    allFeatures[featureIndex].testCases[testIndex].status = newStatus;
                    allFeatures[featureIndex].testCases[testIndex].executionTime = newTime;
                    
                    console.log('‚úÖ After update in allFeatures - Status:', allFeatures[featureIndex].testCases[testIndex].status);
                    console.log('‚úÖ Test case object now:', allFeatures[featureIndex].testCases[testIndex]);
                    
                } else if (response.status === 404) {
                    // If backend endpoint doesn't exist, use simulation
                    console.warn('‚ö†Ô∏è Backend endpoint kh√¥ng t√¨m th·∫•y, s·ª≠ d·ª•ng simulation');
                    simulateTestExecution(testCase);
                    console.log('‚úÖ After simulation - Status:', allFeatures[featureIndex].testCases[testIndex].status);
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è L·ªói khi ch·∫°y test, s·ª≠ d·ª•ng simulation:', error.message);
                simulateTestExecution(testCase);
                console.log('‚úÖ After simulation - Status:', allFeatures[featureIndex].testCases[testIndex].status);
            }
            
            console.log('üîÑ B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t hi·ªÉn th·ªã');
            console.log('üìä testCase.status:', testCase.status);
            console.log('üìä allFeatures[' + featureIndex + '].testCases[' + testIndex + '].status:', allFeatures[featureIndex].testCases[testIndex].status);
            
            // Update statistics immediately to reflect changes in main view
            console.log('üìù G·ªçi updateTestStatistics()');
            updateTestStatistics();
            
            console.log('üîÑ L√†m m·ªõi modal');
            // Refresh modal to show updated status
            await openFeatureModal(featureIndex);
            
            alert(`‚úÖ K·∫øt qu·∫£: ${allFeatures[featureIndex].testCases[testIndex].status} (${allFeatures[featureIndex].testCases[testIndex].executionTime})`);
        }

        function simulateTestExecution(testCase) {
            // Simulate test execution with random result
            const randomResult = Math.random();
            
            if (randomResult > 0.3) {
                // 70% pass rate
                testCase.status = 'PASSED';
                testCase.executionTime = Math.floor(Math.random() * 5 + 1) + 's';
            } else {
                // 30% fail rate
                testCase.status = 'FAILED';
                testCase.executionTime = Math.floor(Math.random() * 8 + 1) + 's';
            }
            
            console.log('üé≤ Simulation result:', testCase.status, testCase.executionTime);
        }




    </script>

    <!-- Feature Detail Modal -->
    <div id="featureModal" style="display: none;" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-gradient-to-r from-[#52b788] to-[#40916c] text-white px-6 py-4 flex justify-between items-center shadow-lg">
                <div>
                    <h3 id="featureTitle" class="text-2xl font-black"></h3>
                    <p id="featureType" class="text-sm text-green-100 mt-1"></p>
                </div>
                <button onclick="closeFeatureModal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Test Cases Section -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-black text-[#1b4332] flex items-center gap-2">
                            <i class="fas fa-flask text-blue-500"></i> Test Cases cho T√≠nh NƒÉng N√†y
                        </h4>
                        <span id="testCaseCount" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-black">0 cases</span>
                    </div>
                    <div id="featureTestCases" class="space-y-3">
                        <p class="text-gray-500 text-sm italic">Ch∆∞a c√≥ test case</p>
                    </div>
                </div>

                <!-- Add Custom Test Case -->
                <div class="border-t-2 border-gray-200 pt-6">
                    <h4 class="text-lg font-black text-[#1b4332] mb-4 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-green-500"></i> Th√™m Test Case T√πy Ch·ªânh
                    </h4>
                    <div class="space-y-4 bg-[#f8fafb] p-5 rounded-lg border-2 border-[#d1f5d1]">
                        <div>
                            <label class="text-sm font-black text-[#1b4332] mb-2 block">T√™n Test Case</label>
                            <input type="text" id="customTestName" placeholder="VD: ƒêƒÉng nh·∫≠p v·ªõi email kh√¥ng h·ª£p l·ªá" 
                                class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white" />
                        </div>
                        <div>
                            <label class="text-sm font-black text-[#1b4332] mb-2 block">C√°c B∆∞·ªõc Th·ª±c Hi·ªán</label>
                            <textarea id="customTestSteps" placeholder="VD: 1. Nh·∫•p v√†o n√∫t ƒëƒÉng nh·∫≠p&#10;2. Nh·∫≠p email kh√¥ng h·ª£p l·ªá&#10;3. Nh·∫•p n√∫t Submit" 
                                class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white resize-none" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="text-sm font-black text-[#1b4332] mb-2 block">K·∫øt Qu·∫£ D·ª± Ki·∫øn</label>
                            <input type="text" id="customTestExpected" placeholder="VD: Hi·ªÉn th·ªã th√¥ng b√°o l·ªói" 
                                class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white" />
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-black text-[#1b4332] mb-2 block">ƒê·ªô ∆Øu Ti√™n</label>
                                <select id="customTestPriority" class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white">
                                    <option value="Low">Th·∫•p</option>
                                    <option value="Medium" selected>Trung B√¨nh</option>
                                    <option value="High">Cao</option>
                                    <option value="Critical">T·ªõi H·∫°n</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-black text-[#1b4332] mb-2 block">Tr·∫°ng Th√°i</label>
                                <select id="customTestStatus" class="w-full border-2 border-[#d1f5d1] p-3 rounded-lg text-sm focus:outline-none focus:border-[#52b788] focus:ring-2 focus:ring-[#52b788]/30 bg-white">
                                    <option value="PENDING">Ch∆∞a Ch·∫°y</option>
                                    <option value="PASSED">Th√†nh C√¥ng</option>
                                    <option value="FAILED">Th·∫•t B·∫°i</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="addCustomTestCase()" class="w-full bg-gradient-to-r from-[#52b788] to-[#40916c] text-white px-4 py-3 rounded-lg font-black hover:shadow-lg btn-modern transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i> Th√™m Test Case
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

